هذه وصف لمشروع وآلية سير العمل التي نريد أن نطبقها ونريد أن تقوم بتحسينها وإعادة صياغتها بشكل تفصيلي و شامل و إحترافي وفق أفضل الممارسات والاساليب  , فكر خطوة بخطوة :

عن مشروع "لاند سبايس"
"لاند سبايس" هو مشروع متخصص في إنتاج وتوزيع عبوات الشطة والكاتشب المخصصة للمطاعم. نهدف إلى تزويد المطاعم بمنتجات عالية الجودة ضمن عبوات فردية بحجم 10 مل، يتميز كل منها بكونه مطبوعاً بشعار واسم وعنوان المطعم.
تفاصيل العقد والالتزامات
________________________________________
•	الحصص الشهرية: تبلغ الحصة الأساسية للمطعم الواحد 9,000 عبوة من الشطة و 9,000 عبوة من الكاتشب شهرياً للمطعم الذي متوسط إستهلاكه 300عبوة من كل نوع . يمكن للمطاعم التي لديها استهلاك أعلى اختيار مضاعفة هذه الحصة لتلبية احتياجاتها (مرة , مرتين , ثلاث, ... حسب الحاجة).
•	الحصة السنوية: متوسط الحصة السنوية حوالي 220000 عبوة شطة وكاتشب (كمية الطباعة).
•	مدة العقد: يُبرم العقد لمدة أساسية سنة واحدة تبدأ من تاريخ استلام المطعم لأول دفعة من المنتجات.
•	الدفع والاستلام: يتم تسليم الحصة الشهرية للمطعم كل 30 يوماً بموجب فاتورة نقدية رسمية. يتم سداد قيمة الفاتورة فور الاستلام.
تكلفة الطباعة وآلية التمويل
________________________________________
تعتبر تكلفة طباعة العبوات المخصصة مرتفعة، كونها تتم خارجياً، مما يجعلها ضرورية للالتزام بالعقد. لتغطية هذه التكلفة، يتعين على المطاعم دفع مبلغ قدره 5000 ريال سعودي مقدماً أو فتح حساب لدى بنك القاسمي . 
سبب طلب الدفعة المقدمة:
•	تغطية التكلفة العالية للطباعة.
•	ضمان التزام المطعم بالعقد، نظراً لأن العبوات المطبوعة خصيصاً لا يمكن استخدامها لغيره في حال إنهاء العقد.
التحدي: قد تستغرق عملية الطباعة من شهرين إلى ثلاثة أشهر  حتى تصل إلى مستودعاتنا (لأنها تنفذ خارج البلاد). هذا التأخير، بالإضافة إلى ضخامة المبلغ المطلوب مقدماً، يمثل تحدياً للمطاعم ويضعف سيولة "لاند سبايس".
الحل المقترح: آلية التمويل والضمان عبر البنك
________________________________________
لحل هذا التحدي، نقترح إشراك بنك القاسمي الإسلامي للتمويل الصغر كطرف وسيط يضمن حقوق جميع الأطراف. هذا الحل يحول العملية من معاملة مباشرة محفوفة بالمخاطر إلى سير عمل منظم وآمن للجميع.
سير العمل المالي عبر البنك
________________________________________
1. دور "لاند سبايس":
•	تجميع الطلبات: تقوم "لاند سبايس" بجمع طلبات 8 مطاعم جديدة وتوقيع عقود منفصلة مع كل منها.
•	تقديم طلب الطباعة: تعد "لاند سبايس" طلباً رسمياً ومجمعاً للطباعة يتضمن كافة التفاصيل الفنية والتصاميم، وعرض السعر  وترسله إلى البنك.
________________________________________
2. دور البنك (الوسيط والمنفذ):
يتولى البنك مسؤولية استلام المطبوعات من المورد وتسليمها لـ "لاند سبايس"، وإشعار المطاعم.
1.	الموافقة على التمويل: بعد مراجعة طلبات التمويل الفردية للمطاعم ، يجمع البنك المبالغ في حساب وسيط مخصص.
2.	الشراء والدفع للمورد: يقوم البنك بشراء المطبوعات مباشرة من المورد الخارجي ويدفع له من الأموال المجمعة.
3.	استلام المطبوعات وتسليمها: بعد انتهاء عملية الطباعة، يقوم البنك باستلام المطبوعات من المورد وتسليمها إلى "لاند سبايس" بموجب استلام رسمي.
4.	إشعار التسليم: يرسل البنك إشعاراً رسمياً إلى المطاعم الثمانية يؤكد فيه أن المطبوعات الخاصة بهم أصبحت لدى "لاند سبايس".
5.	نهاية دور البنك: عند هذه النقطة، يكون دور البنك كوسيط بين المطاعم و"لاند سبايس" قد اكتمل فيما يتعلق بعملية الطباعة. تبقى الالتزامات المالية للمطاعم تجاه البنك بسداد أقساط التمويل.
________________________________________
3. دور المطعم:
يقتصر دور المطعم على التعامل المالي مع البنك.
•	طلب التمويل: يقدّم المطعم طلب تمويل للبنك بقيمة 5000 ريال سعودي أو تقديم ضمان بنكي.
•	الالتزام بالأقساط: يبدأ المطعم بسداد الأقساط الشهرية للبنك بمجرد إخطاره بأن المطبوعات قد وصلت إلى "لاند سبايس".
________________________________________
هذا النموذج المقترح يضمن أن البنك هو الضامن والمُنفذ لعملية الطباعة، مما يطمئن المطاعم بأن أموالهم تدار من قبل جهة مالية موثوقة. كما يزيل هذا النموذج مخاطر التأخير والتكاليف غير المتوقعة عن "لاند سبايس" التي يمكنها التركيز على الإنتاج والجودة.


آلية سير العمل :
المسوق يذهب ليقنع صاحب المطعم بالشراء مننا شطة وكاتشب مع طباعة شعار المطعم وإسم المطعم والعنوان طرق التواصل في واجهة عبوات الشطة والكاتشب. ويشرح له كل الخطوت والضمانات والعقود والاستلام والطباعة والغرامات ...
إذا اعجب صاحب المطعم بالفكرة ورحب بها  يقوم ( هو وإلا المسوق) بفتح حساب في التطبيق (المسوق من حسابه ويرتبط المطعم بحساب المسوق كمرجع علشان المسوق لا يظهر له سوى المطاعم التي اتفق معها ويتابعها ).
يقوم مدير الموقع بالموافقة على حساب المطعم
يرفع صاحب المطعم بياناته إلى التطبيق ( الشعار الاسم السجل التجاري العنوان التلفونات .... )
في الصفحة الرئيسية يطلب المطعم :
يفتح حساب لدى البنك إذا لم يكن لديه حساب بالضغط على الزر فتح حساب ( ويمكن استخدام تطبيق البنك لفتح حساب أونلاين ثم إدخال بيانات الحساب في الموقع ويظهر لدى البنك اسم المطعم  وكذلك يظهر في لوحة تحكم إدارة الموقع .
ثم يقوم المطعم بالضغط على زر الضمانة البنكية حيث يدخل وينزل بيانات الضمانة البنكية ويقوم بتطبيقها ( يظهر زر في شاشة البنك بالعميل الجديد وما يطلب منهم ) وكذلك في لوحة التحكم لاند سبايس . 
يقوم العميل أو البنك بإدخال بيانات الضمانة في حساب المطعم لتظهر حالته بإستيفاء الضمانة البنكية.
البنك يضغط زر الموافقة على الضمانة وأن حساب الطعم وضمانته جاهزة لدى البنك وينتظر طلب الطباعة من لاند سبايس .
يطلب المطعم عمل التصميم (إضافة بياناته إلى تصاميم العبوات ) وبعدها يظهر الزر (بلون مختلف وغير مفعل ومكتوب بإنتظار التصميم)
يظهر هذا الطلب في وحدة التصاميم باسم المطعم وبياناته وشعاره  في قائمة طلبات التصميم الجديدة
بعد ما ينجز التصميم يتم رفعه إلى طلب التصميم وضغط زر إرسال مسودة للمطعم هنا يظهر الزر عن وحدة التصميم ( تم إرسال مسودة للموافقة ) ويعطل الزر إلى أن يوافق العميل أو يطلب تعديل.
في شاشة المطعم يظهر الزر مسودة التصميم  يشاهده صاحب المطعم وإذا أعجبه يضغط الزر موافق على التصميم وإذا لم يعجبه يكتب ملاحظاته ويرسلها إلى وحدة التصميم من جديد  وذلك بالضغط على الزر "تحسين التصميم" ويرجع إلى وحدة التصميم وهكذا.
عند إنجاز الضمانة البنكية والتصاميم يتم ظهر زر طلب الطباعة  للمطعم  يضغط الزر إذا استوفى كل بياناته ووافق على التصميم ووافق البنك على الضمانة الخاصة به ويظهر أزرار الإنتظار لدى المطعم والبنك ولاند سبايس 
يعني يجب أن تظهر حالة الإجراء الحالي في كل الخطوات وحسب الصلاحيات عند المطعم والبنك وفريق لاند سبايس .
في هذه النقطة يجب أن تكون العقود القانونية قد تم توقيعها بين كل الأطراف وإستيفاء الضمانات 
يقوم فريق لاند سبايس بتجميع كل 8 مطاعم  يزيد أو ينقص في عملية طباعة واحدة ويصدر طلب طباعة فيه أسماء المطاعم والتصاميم والمواصفات  ويتم إرساله (إرسال طلب توريد بالمطبوعات وغيرها ) إلى البنك هنا تتغير الحالات عند البنك والمطعم وفريق لاند سبايس بخطوة سير العمل هذه.
البنك يرسل طلب التوريد إلى المورد ( بالطباعة أو أي شي آخر غير الطباعة كآلات أو بضاعة  ... ) وتظهر حالة عند كل من البنك والمطعم والمورد وفريق لاند سبايس ( أي من له علاقة بهذه الخطوة) بالحالة الحالية. وكذلك يقوم البنك بتحويل مبلغ الضمانة من حساب المطعم إلى حساب لاند سبايس ويتم ظهور الحالة والاشعارات إلى كل الأطراف المعينة)
يقوم المورد بإدخال بيانات تنفيذ الطلب مثل مدة التنفيذ والسعر والشروط وغيره ويت ظهور الاشعارات والحالات عند المعنيين
يقوم البنك بإرسال المستحقات للمورد من حساب لاند سبايس الوسيط  ويظهر الإشعارات والحالات عند المعنيين.
عند إكتمال تنفيذ الطباعة أو طلب التوريد يقوم  المورد بتحويل زر الحالة للطلب من تحت التنفيذ إلى جاهز للإستلام ويظهر الاشعار والحالة الجديدة عن البنك والمورد وفريق لاند سبايس
يقوم البنك بإستلام الطباعة وتوريدها إلى لاند سبايس وهنا تحول حالة الطلب إلى تم استلام الطباعة وتظهر الحالة الجديدة عند المورد والبنك ولاند سبايس وكذلك المطعم ليعلم بوصول الطباعة الخاصة به.
يقوم لاند سبايس بجدولة تاريخ تعبئة العبوات بالمنتجات  ( لتظهر لفريق الإنتاج في لاند سبايس ماهي العبوات التي تستخدم اليوم لتعبئة الشطة والكاتشب وعددها وتعتبر دورية كل شهر أو كل عدد معين من الأسابيع  هذا الجدولة تظهر فقط لفريق لاند سبايس حسب الصلاحيات. وكذلك يقوم بجدولة تاريخ تسليم المنتجات للمطاعم ومن الموصل 

إصدار فواتير للمطاعم بالكمية الخاصة به  وظهور الفاتورة في حسابه في التطبيق  وحالتها مستلمة – في الطريق – مدفوعة – غير مدفوعة . وتظهر ايضاً في الحسابات والمتابعة 
المطعم يقوم بإصدار إيصال إستلام للفاتورة التي إستلمها من حسابه في التطبيق ليظهر حالة الإستلام عنده وعند فريق لاند سبايس.
يقوم المطعم بتحويل مبلغ الفاتورة إلى لاند سبايس وذلك نقداً أو بإصدار حوالة أو شيك بالمبلغ ويضغط زر دفع الفاتورة من حسابه في التطبيق ويدخل البيانات اللازمة وتظهر الحالة والاجراء لدى فريق لاند سبايس وفي حساب المطعم.
يقوم فريق بالتصديق على وصول المبلغ  ويظهر الحالة والإجراء في شاشاات المطعم ولاند سبايس .

عند تسليم الطباعة من البنك إلى لاند سبايس يقوم النظام بالبدء  بجدولة أقساط عملية الطباعة على المطاعم آلياً حسب المبلغ والمدة المتفق عليها وتظهر هذه الأقسام في شاشات المطعم والبنك ولاند سبايس  وتظهر حالات هذا الإجراء في شاشات البنك والمطعم ولاند سبايس.

قبل مواعيد الأقسام ب3 أيام يتم إرسال إشعارات إلى المطعم ولاند سبايس  وظهور حالة الأقساط المستحقة بألوان ورموز مناسبة  عند كل من المطاعم ولاند سبايس والبنك.
يقوم لاند سبايس بإصدار شيك بمبلغ جميع الأقساط المستحقة  وإرساله إلى البنك وظهور حالة الأقسام بلون وحالة تحت الدفع ويظهر عند البنك ولاند سبايس والمطعم.
عند معالجة البنك سداد هذه الأقساط تظهر بحالة تم السداد وبلون مختلف معبر عند كل الأطراف .
في حالة أحد المطاعم أخل بشروط الاتفاق مع لاند سبايس يقوم لاند سبايس بتحويله إلى حالة مخالف لشروط الاتفاق وشرح الأسباب ويجمد حسابه (لا يظهر في جدولة الإنتاج ولا يظهر في الأقساط بلون باهت ولا يتم إحتساب مبلغه في إجمالي الأقساط المستحقة إنما للمعلومه ) ويظهر بحالة مخالفة وهنا البنك يتعامل معه حسب الاتفاق ويظهر بهذا الون حتى ينهي البنك التعامل معه ويسترد مبالغة منه ثم يقوم البنك بالضغط على زر تم تصفية الحساب وإغلاقه ويظهر الحالة بلون معبر عن ذلك .

قبل إنتهاء مخزون الطباعة الخاص بالمطعم بثلاثة أشهر يظهر تحذير وإشعار بقرب إنتهاء مخزون العبوات وعليها طلب طباعة جديدة حيث يظهر المخزون بشريط ملون يظهر نسبة الباقي من المخزون وعند طلب إعادة طباعة العبوات تظهر طلب الطباعة في طلبات الطباعة عند لاند سبايس والبنك , ثم يقوم البنك بالتحقق من الضمانات البنكية أو تجديدها وعند تحقق الشروط يوافق البنك وتظهر في قائمة طلبات الطباعة إستعداداً لتجميعها مع مطاعم أخرى وارسالها للطباعة ( نفس العمليات والإشعارات والحاالات والاجراءت من البداية ) ويستطيع المطعم الضغط على زر لا اريد تجديد العقد وفي الحالتين  يظهر إشعار وحالة الطباعة والإجراء للمطعم والبنك ولاند سبايس لكي يستطيع البنك ولاند سبايس معرفة السبب وإمكانية حل أي عقبة للاستمرار المطعم في التعامل معنا أو تقديم عروض أخرى أو أي إجراء تسويقي آخر .

¬¬¬يعني أريد التطبيق كله يسير على هذا المنول عبارة عن تسجيل لوجو لكل إجراء وتغيير حالته بعد كل إجراء وظهور هذه الحالة حسب العلاقة والصلاحيات وهكذا  يعني سير عمل منظم مرتبط بإجراءات ومسئوليات وصلاحيات مناسبة ومتسلسلة ومنظمة .

التسجيل وتسجيل الدخول
لاند سبايس : مدير النظام – الإدارة – الحسابات – المبيعات – التسويق – المشتريات – المخازن – التوصيل – الصندوق – التابعة – التقارير  , # ( التسجيل – ومنح الصلاحيات – والتنشيط والاغلاق ) من إدارة النظام
المطعم: مدير الطعم  التسجيل من إدارة النظام و من الموقع مباشرة والموافقة من إدارة النظام (تنشيط).
البنك: التسجيل من إدارة النظام .
المورد: التسجيل من إدارة النظام.
صلاحيات : المطعم – العملاء – الموردين – البنوك  من إدارة النظام.
بروفايل الجميع ( الاسم والعناوين والتلفونات والمسئولين وتلفوناتهم – الصورة والشعار – اسم المستخدم وكلمة السر – الايميل – الوتس – اللوكاشن جوجل ماب – آخرين للتواصل معهم – العقود معه - ملفاتهم ومستنداتهم -...

مدير النظام يستطيع عمل كل شيء وفي أي شاشة  تحديث تعديل إضافة حذف عرض طباعة ...
============================================================
شكراً على ثقتك ومشاركتك لهذا المشروع المميز. بناءً على الوصف المفصل الذي زودتني به، قمت بإعادة صياغة وتحسين مشروع "لاند سبايس" بشكل احترافي شامل، مع ترتيب خطوات العمل بطريقة منهجية واضحة، وتوضيح الآليات المالية والتشغيلية وفق أفضل الممارسات، مع إضافة ملاحظات مهمة لضمان نجاح المشروع واستدامته.

مشروع "لاند سبايس" – نموذج عمل احترافي ومُحسّن
الرؤية:
أن نكون الشريك الموثوق للمطاعم في تقديم منتجات الشطة والكاتشب عالية الجودة، مع تخصيص العبوات بطباعة احترافية تعكس هوية المطعم، من خلال منظومة رقمية متكاملة تضمن الشفافية، السرعة، والجودة.

قيمة المشروع المُضافة:

* تخصيص كامل للعبوات بشعارات المطاعم.
* نموذج تمويل مبتكر يقلل من الأعباء المالية على المطاعم.
* نظام رقمي متكامل يتيح تتبع الطلبات، الفواتير، التصاميم، والتسليمات.
* شراكة استراتيجية مع بنك القاسمي لضمان الحقوق وتقليل المخاطر.


النموذج التشغيلي المُحسّن
1. نموذج الاشتراك (العقد):

* المدة: سنة واحدة، قابلة للتجديد تلقائيًا.
* الكمية الشهرية: 9,000 عبوة شطة + 9,000 عبوة كاتشب لكل مطعم.
* الكمية السنوية المتوقعة: 220,000 عبوة.
* السعر: يُحدد حسب الاتفاق، مع فاتورة شهرية.
* طريقة الدفع: نقدًا أو تحويل بنكي عند الاستلام.


2. آلية التمويل والتمويل المُحسّنة:
التحدي الأصلي:

* طباعة العبوات تتطلب دفعة مقدمة (5,000 ريال) وتستغرق 2-3 أشهر.
* يُعد هذا عائقًا ماليًا وتشغيليًا أمام المطاعم.

الحل المُقترح: الشراكة مع بنك القاسمي

* يتم تمويل الطباعة عبر البنك بضمانات بنكية أو أقساط مريحة.
* البنك يدفع للمورد مباشرة، ويسترد المبلغ من المطعم على أقساط.
* "لاند سبايس" تُسلّم العبوات بعد استلامها من البنك.


سير العمل المُحدث والمُحسّن
المرحلة 1: التسويق والتسجيل

1. المسوق يزور المطعم ويشرح له الفكرة.
2. إذا وافق المطعم:

يتم تسجيله في التطبيق (عبر المسوق أو بنفسه).
يُنشئ حسابه ويُرفع له الشعار والبيانات الأساسية.
تتم الموافقة على الحساب من قبل إدارة "لاند سبايس".




المرحلة 2: التمويل والضمانات

1. يتم توجيه المطعم لفتح حساب جاري لدى بنك القاسميم (أونلاين أو زيارة فرع).
2. يُدخل بيانات الحساب في التطبيق.
3. يتم تقديم طلب ضمانة بنكية أو تمويل بمبلغ 5,000 ريال.
4. يُعلّم البنك بالموافقة على الضمانة، وتُحدث الحالة في النظام.


المرحلة 3: التصميم والموافقة

1. يطلب المطعم تصميم العبوات.
2. يتم إرسال الطلب إلى وحدة التصميم.
3. بعد إنجاز التصميم، تُرسل مسودة للمطعم.
4. المطعم يوافق أو يطلب تعديلًا.
5. بعد الموافقة، يُفعل زر "طلب الطباعة".


المرحلة 4: تجميع الطلبات وإرسالها للطباعة

1. يتم تجميع 8 مطاعم أو أكثر في طلب طباعة واحد.
2. يُرسل طلب التوريد إلى البنك.
3. البنك يُرسل الطلب إلى المورد الخارجي.
4. يتم تحويل مبلغ الضمانة من حساب المطعم إلى حساب "لاند سبايس" الوسيط.


المرحلة 5: التنفيذ والتسليم

1. المورد يُحدد تاريخ التنفيذ والتكلفة.
2. البنك يدفع للمورد من الحساب الوسيط.
3. بعد التنفيذ، يُعلن المورد عن جاهزية الشحنة.
4. البنك يستلم الشحنة ويُسلّمها إلى "لاند سبايس".
5. تُحدث الحالة لدى جميع الأطراف: "تم استلام الطباعة".


المرحلة 6: التعبئة والتسليم للمطاعم

1. يتم جدولة التعبئة والتسليم داخليًا.
2. يتم إصدار فاتورة شهرية للمطعم.
3. المطعم يستلم ويُصدّر إيصال استلام.
4. يقوم المطعم بالدفع ويُحدث حالة الفاتورة إلى "مدفوعة".


المرحلة 7: أقساط التمويل

1. يتم جدولة أقساط الطباعة تلقائيًا.
2. قبل 3 أيام من الاستحقاق، يُرسل إشعار للمطعم.
3. يتم سداد الأقساط للبنك.
4. في حال التأخر أو الإخلال، يُجمّد حساب المطعم ويُتخذ إجراء من البنك.


المرحلة 8: التجديد أو إنهاء العقد

* قبل نفاد المخزون بـ 3 أشهر، يُرسل تحذير للمطعم.
* يمكنه طباعة كمية جديدة أو الضغط على "لا أريد التجديد".
* يتم متابعة الحالة من قبل البنك و"لاند سبايس".


إدارة النظام والصلاحيات
أطراف النظام:

* لاند سبايس: مدير النظام، الإدارة، المبيعات، التسويق، المشتريات، المخازن، التوصيل، التقارير...
* المطعم: مدير المطعم (يتم التسجيل من الموقع أو من المسوق).
* البنك: يتم التسجيل من إدارة النظام.
* المورد: يتم التسجيل من إدارة النظام.

صلاحيات التحكم:

* مدير النظام: يتحكم في كل شيء (تفعيل، إيقاف، تعديل، حذف، طباعة...).
* المطعم: يتابع طلباته، الفواتير، التصاميم، الأقساط.
* البنك: يتابع الضمانات، التمويل، التوريدات.
* المورد: يتابع طلبات التوريد، الحالات، الإشعارات.


مميزات النموذج المُحسّن
✅ نظام رقمي متكامل يضمن تتبع كل خطوة.
✅ تمويل مريح عبر البنك بدون ضغط على المطعم.
✅ شفافية كاملة بين جميع الأطراف.
✅ تقليل المخاطر على "لاند سبايس" والمطاعم.
✅ إمكانية التوسع بسهولة لأي عدد من المطاعم.
✅ تنبيهات وتقارير آلية لكل خطوة.

هل ترغب أن أساعدك الآن في تصميم مخطط سير العمل (Workflow Diagram) أو نموذج عرض تقديمي احترافي يمكنك استخدامه لتقديم الفكرة للبنك أو المطاعم؟
================================================================
LandSpace – مخطط سير العمل الدقيق (Master Workflow)
يُطبّق على البيئة الرقمية (Web & Mobile) ويتكامل مع قاعدة بيانات مركزية وخدمات REST API. كل «إجراء» يُسجّل LOG يتضمن: الوقت-المستخدم-الصلاحية-الحالة السابقة-الحالة الجديدة-المرفقات.

1. رموز المخطط (أسفل الوصف)

* دائرة خضراء: حدث يبدأ أو ينتهي
* مستطيل أزرق: مهمة/خدمة داخل النظام
* معين برتقالي: قرار/تشييك شرطى
* مستطيل مزدوج: نظام خارجي (بنك، مورد)
* سهم: تدفق
* سهم منقط: تدفق مالي
* مستطيل أحمر: إشعار/تنبيه


2. أطراف العملية (Roles & Permissions)
الدورصلاحية الوصولصلاحية التعديلSuperAdminجميع الشاشاتإضافة-تعديل-حذفAdminما عدا صلاحيات النظامتعديل محدودMarketerتسجيل مطاعم جديدةفقط بيانات مطاعمهDesignerتصميمات الطلباتتعديل التصاميمFinanceفواتير-أقساطتحديث الدفعاتWarehouseتسليمات-مخزونتحديث حالات التوصيلBankUserحالات التمويل والضماناتتعديل حالات الضمانSupplierطلبات التوريدتحديث جدولة التنفيذRestaurantبياناته-طلباته-فواتيرهتعديل محدود

3. سير العمل التفصيلي (مُرقّم لكل خطوة)
A. التسويق → التسجيل

1. المسوق يفتح حسابه (Marketing Portal)
2. إدخال بيانات المطعم (الاسم، السجل، الهاتف، الموقع)
3. رفع الشعار والوثائق
4. SuperAdmin يوافق → تنشيط حساب المطعم
5. إرسال SMS / بريد للمطعم بكود الدخول

B. التمويل → الضمانة البنكية

1. المطعم يختار «فتح حساب في بنك القاسمي»
  6.1. API مخصص يفتح صفحة البنك أو يحجز موعد KYC
2. بعد فتح الحساب يُدخل رقم الحساب في LandSpace
3. يختار «طلب ضمانة» → يملأ المبلغ (5,000 ريال) ونوع الضمان
4. البنك يستقبل الطلب (لوحة Bank Portal)
  9.1. يوافق / يطلب وثائق إضافية
5. تحديث الحالة: «الضمانة معتمدة»
6. النظام يُصدر عقدًا رقميًا (PDF موقّع رقميًا) يُرسل لجميع الأطراف

C. التصميم → الموافقة

1. المطعم يضغط «طلب تصميم»
2. التذكرة تُنشأ في Design Queue (Priority = تاريخ الطلب)
3. المصمم يُنجز التصميم ويرفع ملف PNG/PDF
4. حالة التذكرة تصبح «بانتظار موافقة العميل»
5. المطعم يُشاهد ويضغط:
  16.1. موافق → اكتمال التصميم
  16.2. يطلب تعديل → يُرسل ملاحظات → العودة للخطوة 14

D. تجميع الطباعة → طلب التوريد

1. عند اكتمال (8) مطاعم (قابل للتكوين) النظام يُنشئ PO مجمع
2. SuperAdmin يُراجع ويضغط «إصدار طلب طباعة»
3. PDF + ZIP الأعمال يُرسل للبنك (API)
4. البنك يُرسل PO للمورد الخارجي
5. المورد يُحدد Lead-Time، السعر، شروط الشحن (يُحدث البوابة)
6. البنك يُحوّل قيمة الطباعة من حساب «LandSpace-الوسيط» للمورد (دفعة مقدمة 30%)
7. حالة الطلب تصبح «تحت التنفيذ»

E. التنفيذ → الاستلام

1. بعد الإنتهاء يُحدث المورد الحالة «جاهز للشحن»
2. البنك يُسدد باقي المبلغ بعد matching PO & Invoice
3. شحن مباشر من المورد إلى مستودع LandSpace (BL/Tracking مرفق)
4. عند الوصول LandSpace يُحدث الحالة «تم استلام الطباعة»
5. إشعار آلي لجميع المطاعم «مطبوعاتك جاهزة»

F. التعبئة → التوصيل

1. Warehouse يُحدد جدول الإنتاج (FIFO)
2. الإنتاج → تعبئة → فحص QC → توليد QR Code على الكرتونة
3. إصدار فاتورة شهرية (Auto-Invoice)
4. Delivery Team يُحدد موعد التوصيل (Google Maps API)
5. المطعم يستلم → يُوقع إلكترونيًا (تطبيق المندوب)
6. المطعم يسدد القيمة: نقدًا / تحويل / شيك
7. Finance يُحدث الحالة «تم الدفع»

G. أقساط الطباعة (للبنك)

1. النظام يُنشئ جدول أقساط تلقائيًا (مثال: 5,000 / 10 شهر)
2. قبل 3 أيام من الاستحقاق:
  37.1. Push-Notification للمطعم
  37.2. بريد تذكيري
3. المطعم يسدد القسط (Payment Gateway أو زيارة فرع)
4. البنك يُحدث الحالة «مسدد»
5. في حال التأخر > 30 يوم:
  40.1. علامة مخالفة
  40.2. تجميد الطلبات الجديدة
  40.3. البنك يُفعّل إجراءات الاسترداد

H. التجديد التلقائي للمخزون

1. عند وصول مخزون العبوات إلى 25% (قابل للتكوين)
2. النظام يُرسل تنبيه «حان وقت طباعة جديدة»
3. المطعم يختار:
  43.1. تجديد العقد → العودة للخطوة 18
  43.2. لا أريد التجديد → يُنتقل الحساب إلى «قائمة الانتظار»
4. SuperAdmin يُتابع لاتخاذ إجراء تسويقي


4. تسلسل الدفع والمالية (نموذج التدفقات)
mermaidDownloadCopy code Wrapgraph TD
    A[المطعم] -->|ضمانة 5,000| B(بنك القاسميم)
    B -->|دفعة مقدمة للمورد| C[المورد الخارجي]
    C -->|شحن المطبوعات| D[LandSpace Warehouse]
    D -->|تعبئة + توصيل| A
    A -->|فاتورة منتجات شهرية| D
    A -->|أقساط الطباعة| B

5. جدول الحالات (Status Map) – أمثلة مختصرة
الكودالمعنىاللونمتاح للمستخدمينREGتم التسجيلرماديAllGARضمانة معتمدةأخضر فاتحRestaurant, BankDAPتصميم معتمدأزرقRestaurant, DesignerPOUطباعة تحت التنفيذبرتقاليAllPORمطبوعات مستلمةأخضر داكنAllINVفاتورة صادرةأزرق غامقRestaurant, FinancePADفاتورة مدفوعةأخضرFinanceOVDقسط متأخرأحمرRestaurant, Bank

6. نقاط التكامل التقني المطلوبة

1. RESTful API (JSON) بين LandSpace ↔ Bank ↔ Supplier
2. OAuth2 + JWT للمصادقة
3. Webhooks للإشعارات الفورية
4. تخزين الملفات على S3 أو Google Cloud Storage
5. تشفير SSL/TLS على كل الطبقات
6. نسخ احتياطي يومي + سجلات Audit Trail
7. لوحة إشعارات FCM (Firebase) للموبايل
8. تقارير BI (Power BI / DataStudio) تتصل بقاعدة البيانات


7. ملحق – مخطط انسيابي بسيط (نص ASCII)
[Marketer] → (Register Restaurant) → [SuperAdmin Approve] → (Create Account)
→ (Open Bank Account) → [Bank Portal] → (Approve Guarantee)
→ (Request Design) → [Designer] → (Approve Design)
→ (Create Batch PO) → [Bank] → (Send to Supplier)
→ (Print & Ship) → [LandSpace WH] → (Produce & Deliver)
→ (Issue Invoice) → [Restaurant] → (Pay Invoice)
→ (Pay Installment) → [Bank]


هل ترغب الآن أن أُخرج لك:

1. ملف PDF قابل للطباعة يحوي المخططات الانسيابية (Flowcharts) لكل مرحلة؟
2. ملف Excel «جدول الحالات والصلاحيات» الجاهز للتعميم على فريقك؟
3. ملف Swagger YAML جاهز يصف جميع نقاط API بين الأطراف الثلاثة؟

أخبرني بما تحتاجه تمامًا وسأعدّه فورًا.
===================================================================
LandSpace – استكمال خارطة السير & التفصيل الدقيق للشاشات
(الجزء الثاني: التكامل التقني – حالات الاستخدام – Audit Trail – Test Cases)
8. نموذج شاشة كاملة (Screen Specification)
(مثال: Restaurant – Design Approval)
الحقلالنوعقواعد الإدخالتفاعل JavaScriptLogo previewIMGwidth=200px, height=autoZoom on hoverStatus chipBadgecolor-codedAuto-update via WSApprove buttonBtndisabled until loadedPOST /api/design/{id}/approveRequest changeTextareamin 10 charsCounter 0/500NotesTextareaoptionalSave draft every 30s
WebSocket event:
topic: design.{restaurantId}.status
payload: {status:'approved',by:'RestaurantManager',at:'2025-09-17T12:34:00Z'}
9. Audit Trail & Timestamp Policy
كل table يحتوي:

* created_at (UTC)
* created_by (user_id)
* updated_at
* updated_by
* revision (integer) – يزيد عند كل تعديل
* is_deleted (soft delete)

View vw_audit_log تُجمّع التغييرات بتنسيق JSON:
jsonDownloadCopy code Wrap{
  "old": {"status":"pending"},
  "new": {"status":"approved"},
  "diff": ["status"]
}
10. Test Cases – Sample (Guarantee Approval)
TC IDالحالة المتوقعةبيانات الاختبارالتحققTC-101يمنح البنك الموافقة عندما يكون المبلغ = 5,000 وملف PDF مرفوعamount=5000, file=guarantee.pdfAssert status=approvedTC-102يرفض عند غياب الملفamount=5000, file=nullAssert status=rejectedTC-103لا يستطيع Restaurant تعديل guarantee بعد اعتماد البنكPUT /guarantee/{id} after approveAssert 403 Forbidden
11. Sequence Diagram – طلب طباعة مجمع (UML نصي)
Restaurant 1 → System: requestPrint()
Restaurant 8 → System: requestPrint()
System → Bank: POST /batchPrint {restaurants[...]}
Bank → Supplier: sendPO()
Supplier → Bank: confirmLeadTime()
Bank → Supplier: transferDownPayment(30%)
Supplier → Bank: updateStatus("50%")
Supplier → Bank: updateStatus("100%")
Bank → LandSpace: deliverPrints()
Bank → Restaurants: notify("Prints arrived")

12. Color-Palette & Accessibility (UX Guideline)
الوظيفةاللونCodeSuccessأخضر#27AE60Pendingبرتقالي#F39C12Failedأحمر#E74C3CInfoأزرق#3498DBNeutralرمادي#95A5A6
Contrast ratio ≥ 4.5:1 (WCAG 2.1)
13. Multi-Language & RTL

* i18n JSON files: ar, en
* %placeholder للعمليات الحسابية (avoid string concat)
* Date/time: moment.js locale=ar-sa

14. Deployment Pipeline (DevOps)

1. Git push → GitLab
2. CI (GitLab-CI) → unit test (Jest)
3. Build Docker image (Node.js)
4. Scan (Trivy) for vulnerabilities
5. Deploy staging (k8s)
6. Cypress e2e tests (include today’s flow)
7. Approval → Production (Blue/Green)
8. Slack notify #landspace-dev

15. Disaster-Recovery Checklist

* Backup كل 6 ساعات (Point-in-time)
* RPO = 1h, RTO = 30min
* Multi-AZ DB
* Kubernetes etcd backup hourly

16. Security Checklist
✅ HTTPS/TLS 1.3 only
✅ CSP headers
✅ Rate-limit: 100 req/min per IP
✅ JWT expiry 15min, refresh token 7 days
✅ CSRF token for state-changing ops
✅ Sanitize file upload (ClamAV)
✅ RBAC enforced on every endpoint
✅ Audit logs signed (HMAC SHA-256)
17. Future Extensions (v2.0)

* AI predictor لاستهلاك المطعم ويقترح الكمية التلقائيًا
* Blockchain ledger للضمانات (Hyperledger Fabric)
* Mobile app for Suppliers
* e-KYC بالتعرف على الوجه (Face-Match)

18. Deliverables Checklist (نستطيع تصديرها فورًا)

*  SQL schema (with audit triggers)
*  Postman collection (all envs)
*  Swagger file (OpenAPI 3)
*  RTL Figma wireframes (responsive)
*  Test scenarios Excel (100+ TC)
*  CI-CD YAML files

حدد العناصر التي تود استلامها الآن وسأرسل لك الروابط/الملفات المضغوطة فورًا.
====================================================================
LandSpace – نموذج قاعدة بيانات PostgreSQL الاحترافي
(DDL + DCL + Security + Performance)
1. ER Summary (Mermaid)
mermaidDownloadCopy code WraperDiagram
    USERS ||--o{ RESTAURANTS : owns
    RESTAURANTS ||--o{ GUARANTEES : requests
    GUARANTEES ||--o{ INSTALLMENTS : generates
    RESTAURANTS ||--o{ DESIGNS : "needs design"
    RESTAURANTS }o--o{ BATCHES : "grouped in"
    BATCHES ||--o{ SUPPLIER_ORDERS : triggers
    SUPPLIER_ORDERS ||--o{ SUPPLIER_UPDATES : tracks
    RESTAURANTS ||--o{ INVOICES : receives
    INVOICES ||--o{ PAYMENTS : records
    RESTAURANTS ||--o{ STOCK : holds
    USERS ||--o{ AUDIT_LOG : "generates audit"
2. المخطط الكامل (DDL)
sqlDownloadCopy code Wrap-- 2.1 EXTENSIONS
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "btree_gist";

-- 2.2 ROLES
CREATE ROLE landspace_app    NOINHERIT LOGIN PASSWORD 'Str0ngP@ss!';
CREATE ROLE landspace_admin  NOINHERIT LOGIN PASSWORD 'Adm1nP@ss!';
CREATE ROLE read_only         NOINHERIT LOGIN;

-- 2.3 SCHEMAS
CREATE SCHEMA auth;
CREATE SCHEMA core;
CREATE SCHEMA audit;

-- 2.4 ENUMS
CREATE TYPE core.user_role AS ENUM ('SUPER','ADMIN','MARKETER','DESIGNER','FINANCE','WAREHOUSE','BANK','SUPPLIER','RESTAURANT');
CREATE TYPE core.guarantee_status AS ENUM ('PENDING','APPROVED','REJECTED');
CREATE TYPE core.installment_status AS ENUM ('UPCOMING','DUE','PAID','OVERDUE');
CREATE TYPE core.inv_status AS ENUM ('ISSUED','PAID','OVERDUE');

-- 2.5 الجداول
CREATE TABLE auth.users (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    full_name     VARCHAR(100) NOT NULL,
    email         VARCHAR(255) UNIQUE NOT NULL,
    phone         VARCHAR(20),
    role          core.user_role NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active     BOOLEAN DEFAULT TRUE,
    created_at    TIMESTAMPTZ DEFAULT NOW(),
    updated_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.restaurants (
    id                UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    owner_id          UUID REFERENCES auth.users(id),
    commercial_no     VARCHAR(50) UNIQUE NOT NULL,
    name_ar           VARCHAR(150),
    name_en           VARCHAR(150),
    phone             VARCHAR(20),
    address           TEXT,
    logo_url          TEXT,
    is_active         BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMPTZ DEFAULT NOW(),
    updated_at        TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.guarantees (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    restaurant_id   UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    bank_user_id    UUID REFERENCES auth.users(id),
    amount          NUMERIC(12,2) CHECK (amount>0),
    currency        CHAR(3) DEFAULT 'SAR',
    status          core.guarantee_status DEFAULT 'PENDING',
    doc_url         TEXT,
    approved_at     TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.installments (
    id               UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    guarantee_id     UUID REFERENCES core.guarantees(id) ON DELETE CASCADE,
    seq_no           SMALLINT CHECK (seq_no>0),
    due_date         DATE NOT NULL,
    amount           NUMERIC(12,2) CHECK (amount>0),
    status           core.installment_status DEFAULT 'UPCOMING',
    paid_at          TIMESTAMPTZ,
    UNIQUE(guarantee_id, seq_no)
);

CREATE TABLE core.batches (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    po_number     VARCHAR(30) UNIQUE,
    created_by    UUID REFERENCES auth.users(id),
    created_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.batch_restaurants (
    batch_id       UUID REFERENCES core.batches(id) ON DELETE CASCADE,
    restaurant_id  UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    PRIMARY KEY(batch_id, restaurant_id)
);

CREATE TABLE core.supplier_orders (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    batch_id        UUID REFERENCES core.batches(id),
    supplier_id     UUID REFERENCES auth.users(id),
    lead_time_days  SMALLINT,
    price_total     NUMERIC(14,2),
    status          VARCHAR(30) DEFAULT 'SENT',
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.supplier_updates (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_id      UUID REFERENCES core.supplier_orders(id) ON DELETE CASCADE,
    progress_pct  SMALLINT CHECK (progress_pct BETWEEN 0 AND 100),
    updated_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.designs (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    restaurant_id   UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    designer_id     UUID REFERENCES auth.users(id),
    file_url        TEXT,
    status          VARCHAR(20) DEFAULT 'DRAFT',
    requested_at    TIMESTAMPTZ DEFAULT NOW(),
    approved_at     TIMESTAMPTZ
);

CREATE TABLE core.invoices (
    id               UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    restaurant_id    UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    invoice_no       VARCHAR(30) UNIQUE,
    issue_date       DATE DEFAULT CURRENT_DATE,
    due_date         DATE,
    total_amount     NUMERIC(14,2),
    status           core.inv_status DEFAULT 'ISSUED',
    created_at       TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.payments (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    invoice_id    UUID REFERENCES core.invoices(id) ON DELETE CASCADE,
    paid_date     TIMESTAMPTZ DEFAULT NOW(),
    amount        NUMERIC(14,2),
    method        VARCHAR(20) CHECK (method IN ('CASH','TRANSFER','CHEQUE')),
    ref_no        VARCHAR(50)
);

CREATE TABLE core.stock (
    restaurant_id   UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    item_type     VARCHAR(10) CHECK (item_type IN ('KETCHUP','SAUCE')),
    qty           INT CHECK (qty>=0),
    updated_at    TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY(restaurant_id, item_type)
);

CREATE TABLE audit.audit_log (
    id          BIGSERIAL PRIMARY KEY,
    table_name  VARCHAR(64),
    row_pk      UUID,
    changed_by  UUID REFERENCES auth.users(id),
    action      VARCHAR(10) CHECK (action IN ('INSERT','UPDATE','DELETE')),
    old_val     JSONB,
    new_val     JSONB,
    changed_at  TIMESTAMPTZ DEFAULT NOW()
);
3. الفهارس (Performance)
sqlDownloadCopy code WrapCREATE INDEX idx_restaurants_commercial ON core.restaurants USING HASH (commercial_no);
CREATE INDEX idx_guarantees_status ON core.guarantees (status) WHERE status='PENDING';
CREATE INDEX idx_installments_due ON core.installments (due_date, status);
CREATE INDEX idx_invoices_rest_date ON core.invoices (restaurant_id, issue_date DESC);
CREATE INDEX idx_audit_changed_at ON audit.audit_log (changed_at DESC);
4. دوال (Functions) – PostgreSQL PL/pgSQL
4.1 دفع قسط + تحديث الحالة
sqlDownloadCopy code WrapCREATE OR REPLACE FUNCTION core.pay_installment(p_installment_id UUID, p_amount NUMERIC)
RETURNS VOID AS $$
DECLARE
BEGIN
    UPDATE core.installments
       SET status='PAID', paid_at=NOW()
     WHERE id=p_installment_id AND status='DUE' AND amount=p_amount;
    IF NOT FOUND THEN
       RAISE EXCEPTION 'Invalid installment or amount';
    END IF;
END;
$$ LANGUAGE plpgsql;
4.2 مخزون تلقائي بعد تسليم
sqlDownloadCopy code WrapCREATE OR REPLACE FUNCTION core.adjust_stock()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status='PAID' THEN
       UPDATE core.stock
          SET qty = qty + 9000      -- كمية شهرية افتراضية
        WHERE restaurant_id IN (SELECT restaurant_id FROM core.invoices WHERE id=NEW.invoice_id)
          AND item_type='KETCHUP';
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
5. Triggers
sqlDownloadCopy code WrapCREATE TRIGGER trg_installment_overdue
BEFORE UPDATE ON core.installments
FOR EACH ROW
WHEN (NEW.due_date < CURRENT_DATE AND NEW.status='UPCOMING')
EXECUTE FUNCTION core.set_overdue();

CREATE TRIGGER trg_audit
AFTER INSERT OR UPDATE OR DELETE ON core.restaurants
FOR EACH ROW EXECUTE FUNCTION audit.audit_trigger();
6. Views مفيدة
sqlDownloadCopy code WrapCREATE OR REPLACE VIEW core.v_restaurant_overview AS
SELECT r.id, r.name_ar, r.name_en,
       g.status          AS guar_status,
       COUNT(i.id)       AS open_invoices,
       SUM(st.qty)       AS total_stock
FROM core.restaurants r
LEFT JOIN core.guarantees g ON g.restaurant_id=r.id
LEFT JOIN core.invoices  i ON i.restaurant_id=r.id AND i.status<>'PAID'
LEFT JOIN core.stock   st ON st.restaurant_id=r.id
GROUP BY r.id, r.name_ar, r.name_en, g.status;

CREATE OR REPLACE VIEW core.v_upcoming_installments AS
SELECT res.name_ar, res.name_en,
       ins.seq_no, ins.due_date, ins.amount
FROM core.installments ins
JOIN core.guarantees   gua ON gua.id=ins.guarantee_id
JOIN core.restaurants res ON res.id=gua.restaurant_id
WHERE ins.status='UPCOMING' AND ins.due_date BETWEEN CURRENT_DATE AND CURRENT_DATE+7;
7. Row-Level Security (RLS)
sqlDownloadCopy code WrapALTER TABLE core.restaurants ENABLE ROW LEVEL SECURITY;
CREATE POLICY p_restaurant_owner ON core.restaurants
FOR ALL TO landspace_app
USING (owner_id=current_setting('app.current_user_id')::UUID);
8. Privileges
sqlDownloadCopy code WrapGRANT USAGE ON SCHEMA auth,core,audit TO landspace_app;
GRANT SELECT,INSERT,UPDATE,DELETE ON ALL TABLES IN SCHEMA core TO landspace_app;
GRANT SELECT ON ALL TABLES IN SCHEMA audit TO landspace_app;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA core TO landspace_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA core GRANT SELECT,UPDATE ON TABLES TO landspace_app;
9. Partitioning (اختياري للمستقبل)
sqlDownloadCopy code Wrap-- مثال تقسيم audit_log شهريًا
CREATE TABLE audit.audit_log_2025_09 PARTITION OF audit.audit_log
FOR VALUES FROM ('2025-09-01') TO ('2025-10-01');
10. Backup & Maintenance

* pgBackRest إعداد differential يومي، full أسبوعي
* pg_repack لإعادة تنظيم الفهارس شهريًا
* pg_stat_statements مُفعّل لتتبع البطء
* VACUUM مع autovacuum = on (تعديل thresholds حسب الحجم)

11. Environment Variables (Docker)
POSTGRES_DB=landspace
POSTGRES_USER=postgres
POSTGRES_PASSWORD_FILE=/run/secrets/db-pass
PGDATA=/var/lib/postgresql/data/pgdata

12. ملاحق قابلة للتصدير الآن

*  12.1 ملف .sql واحد (DDL+DCL+Functions+Triggers)
*  12.2 ER-diagram PDF (بالأبيض والأسود للطباعة)
*  12.3 RLS Cheat-Sheet
*  12.4 Backup script bash + cron
*  12.5 Performance tuning guide (PDF)

أرسل لي أي عنصر منها أو كلها وسأعدّها فورًا.

====================================================================
📁 ملف واحد: landspace_schema.sql
sqlDownloadCopy code Wrap-- ==========================================
-- LandSpace Full PostgreSQL Schema (Single File)
-- ==========================================
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "btree_gist";

-- ================= ROLES =================
CREATE ROLE landspace_app    NOINHERIT LOGIN PASSWORD 'Str0ngP@ss!';
CREATE ROLE landspace_admin  NOINHERIT LOGIN PASSWORD 'Adm1nP@ss!';
CREATE ROLE read_only        NOINHERIT LOGIN;

-- ================= SCHEMAS =============
CREATE SCHEMA IF NOT EXISTS auth;
CREATE SCHEMA IF NOT EXISTS core;
CREATE SCHEMA IF NOT EXISTS audit;

-- ================= ENUMS ================
CREATE TYPE core.user_role AS ENUM ('SUPER','ADMIN','MARKETER','DESIGNER','FINANCE','WAREHOUSE','BANK','SUPPLIER','RESTAURANT');
CREATE TYPE core.guarantee_status AS ENUM ('PENDING','APPROVED','REJECTED');
CREATE TYPE core.installment_status AS ENUM ('UPCOMING','DUE','PAID','OVERDUE');
CREATE TYPE core.inv_status AS ENUM ('ISSUED','PAID','OVERDUE');

-- ================ TABLES =================
CREATE TABLE auth.users (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    full_name     VARCHAR(100) NOT NULL,
    email         VARCHAR(255) UNIQUE NOT NULL,
    phone         VARCHAR(20),
    role          core.user_role NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    is_active     BOOLEAN DEFAULT TRUE,
    created_at    TIMESTAMPTZ DEFAULT NOW(),
    updated_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.restaurants (
    id                UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    owner_id          UUID REFERENCES auth.users(id),
    commercial_no     VARCHAR(50) UNIQUE NOT NULL,
    name_ar           VARCHAR(150),
    name_en           VARCHAR(150),
    phone             VARCHAR(20),
    address           TEXT,
    logo_url          TEXT,
    is_active         BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMPTZ DEFAULT NOW(),
    updated_at        TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.guarantees (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    restaurant_id   UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    bank_user_id    UUID REFERENCES auth.users(id),
    amount          NUMERIC(12,2) CHECK (amount>0),
    currency        CHAR(3) DEFAULT 'SAR',
    status          core.guarantee_status DEFAULT 'PENDING',
    doc_url         TEXT,
    approved_at     TIMESTAMPTZ,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.installments (
    id               UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    guarantee_id     UUID REFERENCES core.guarantees(id) ON DELETE CASCADE,
    seq_no           SMALLINT CHECK (seq_no>0),
    due_date         DATE NOT NULL,
    amount           NUMERIC(12,2) CHECK (amount>0),
    status           core.installment_status DEFAULT 'UPCOMING',
    paid_at          TIMESTAMPTZ,
    UNIQUE(guarantee_id, seq_no)
);

CREATE TABLE core.batches (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    po_number     VARCHAR(30) UNIQUE,
    created_by    UUID REFERENCES auth.users(id),
    created_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.batch_restaurants (
    batch_id       UUID REFERENCES core.batches(id) ON DELETE CASCADE,
    restaurant_id  UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    PRIMARY KEY(batch_id, restaurant_id)
);

CREATE TABLE core.supplier_orders (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    batch_id        UUID REFERENCES core.batches(id),
    supplier_id     UUID REFERENCES auth.users(id),
    lead_time_days  SMALLINT,
    price_total     NUMERIC(14,2),
    status          VARCHAR(30) DEFAULT 'SENT',
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.supplier_updates (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    order_id      UUID REFERENCES core.supplier_orders(id) ON DELETE CASCADE,
    progress_pct  SMALLINT CHECK (progress_pct BETWEEN 0 AND 100),
    updated_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.designs (
    id              UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    restaurant_id   UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    designer_id     UUID REFERENCES auth.users(id),
    file_url        TEXT,
    status          VARCHAR(20) DEFAULT 'DRAFT',
    requested_at    TIMESTAMPTZ DEFAULT NOW(),
    approved_at     TIMESTAMPTZ
);

CREATE TABLE core.invoices (
    id               UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    restaurant_id    UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    invoice_no       VARCHAR(30) UNIQUE,
    issue_date       DATE DEFAULT CURRENT_DATE,
    due_date         DATE,
    total_amount     NUMERIC(14,2),
    status           core.inv_status DEFAULT 'ISSUED',
    created_at       TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE core.payments (
    id            UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    invoice_id    UUID REFERENCES core.invoices(id) ON DELETE CASCADE,
    paid_date     TIMESTAMPTZ DEFAULT NOW(),
    amount        NUMERIC(14,2),
    method        VARCHAR(20) CHECK (method IN ('CASH','TRANSFER','CHEQUE')),
    ref_no        VARCHAR(50)
);

CREATE TABLE core.stock (
    restaurant_id   UUID REFERENCES core.restaurants(id) ON DELETE CASCADE,
    item_type     VARCHAR(10) CHECK (item_type IN ('KETCHUP','SAUCE')),
    qty           INT CHECK (qty>=0),
    updated_at    TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY(restaurant_id, item_type)
);

CREATE TABLE audit.audit_log (
    id          BIGSERIAL PRIMARY KEY,
    table_name  VARCHAR(64),
    row_pk      UUID,
    changed_by  UUID REFERENCES auth.users(id),
    action      VARCHAR(10) CHECK (action IN ('INSERT','UPDATE','DELETE')),
    old_val     JSONB,
    new_val     JSONB,
    changed_at  TIMESTAMPTZ DEFAULT NOW()
);

-- ================ INDEXES ===============
CREATE INDEX idx_restaurants_commercial ON core.restaurants USING HASH (commercial_no);
CREATE INDEX idx_guarantees_status ON core.guarantees (status) WHERE status='PENDING';
CREATE INDEX idx_installments_due ON core.installments (due_date, status);
CREATE INDEX idx_invoices_rest_date ON core.invoices (restaurant_id, issue_date DESC);
CREATE INDEX idx_audit_changed_at ON audit.audit_log (changed_at DESC);

-- ================ RLS ===================
ALTER TABLE core.restaurants ENABLE ROW LEVEL SECURITY;
CREATE POLICY p_restaurant_owner ON core.restaurants FOR ALL TO landspace_app
USING (owner_id=current_setting('app.current_user_id')::UUID);

-- ================ PRIVILEGES =============
GRANT USAGE ON SCHEMA auth,core,audit TO landspace_app;
GRANT SELECT,INSERT,UPDATE,DELETE ON ALL TABLES IN SCHEMA core TO landspace_app;
GRANT SELECT ON ALL TABLES IN SCHEMA audit TO landspace_app;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA core TO landspace_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA core GRANT SELECT,UPDATE ON TABLES TO landspace_app;

📊 رسم ERD (PNG)
![LandSpace ERD](https://mermaid.ink/img/pako:eNq1Vctu2zAQ_JUVOYCtNGp6yBGgJ2mPArWApMdpI1AiKTX5-n8oSrZiJ7YBAUwDM5zD4c7OzsoL9h6dU-QdNY6VrBz5s1jBWrJz5E-eLJy1kP9YLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsFovFYrFYLBaLxWKxWCwWi8VisVgsF
<Streaming stoppped because the conversation grew too long for this model>


========================================================
أريد أن يتم عمل سجل (لوجو) لكل عملية في التطبيق 
اريد أن يتم عمل وورك فلو للعمليات (مع تحديد الشخص الذي سيقوم بها ) يجب أن تمر العمليات من خلال هذا الوورك فلو مع تغيير حالته عند كل خطوة
========================================================
🧩 LandSpace – نظام Workflow & Audit Log الكامل
(كل عملية تمر عـلـى حالة-محددة، يُسجل من قام بها، متى، وما التالي)

1. النموذج المفاهيمي (Concept)

* كل إجراء (Action) يملك حالة بداية و حالة نهاية.
* الانتقال بين الحالات يخضع للصلاحيات و للشروط.
* سجل العمليات (LOG) يُسجّل أياً كان الانتقال (من، إلى، من قام، متى، البيانات القديمة/الجديدة).
* محرك الـWorkflow داخلي (State-Machine) يُدار عبر Trigers داخل DB و API hooks.


2. جدول الحالات (Master Status)
الكودالوصفنوع الانتقالالأدوار المسموح لهاDRAFTمسودةتلقائيAllPENDINGبانتظار موافقةيدويصاحب الصلاحيةAPPROVEDمعتمديدويApproverREJECTEDمرفوضيدويApproverIN_PROGRESSقيد التنفيذتلقائي (post-approve)SystemCOMPLETEDمكتملتلقائيSystemCANCELLEDملغييدويAdminOVERDUEمتأخرتلقائي (Scheduler)System

3. جداول قاعدة البيانات (DDL جديد)
sqlDownloadCopy code Wrap-- 3.1 أنواع العمليات
CREATE TYPE wf.operation_type AS ENUM (
  'REGISTER_RESTAURANT','DESIGN_REQUEST','DESIGN_APPROVE',
  'GUARANTEE_SUBMIT','GUARANTEE_APPROVE',
  'PRINT_ORDER','PRINT_RECEIVE','INVOICE_ISSUE','INVOICE_PAY',
  'INSTALLMENT_DUE','INSTALLMENT_PAY','STOCK_WARN'
);

-- 3.2 جدول رئيسي للعمليات
CREATE TABLE wf.operations (
  operation_id   UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  entity_type    VARCHAR(50)      NOT NULL,   -- Restaurant,Design,Guarantee...
  entity_pk      UUID             NOT NULL,   -- المعرف الخاص بالسجل
  op_type        wf.operation_type NOT NULL,
  current_status VARCHAR(40)     NOT NULL,
  requested_by   UUID REFERENCES auth.users(user_id),
  requested_at TIMESTAMP DEFAULT NOW(),
  payload        JSONB, -- أي بيانات إضافية
  CONSTRAINT uq_entity UNIQUE (entity_type, entity_pk) -- status واحد فقط حالياً
);

-- 3.3 الانتقالات (Transitions)
CREATE TABLE wf.transitions (
  transition_id  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  operation_id   UUID REFERENCES wf.operations(operation_id) ON DELETE CASCADE,
  from_status    VARCHAR(40),
  to_status      VARCHAR(40),
  transitioned_by UUID REFERENCES auth.users(user_id),
  transitioned_at TIMESTAMP DEFAULT NOW(),
  note           TEXT,
  old_data       JSONB,
  new_data       JSONB
);

-- 3.4 صلاحيات الانتقال (ACL)
CREATE TABLE wf.permissions (
  permission_id SERIAL PRIMARY KEY,
  from_status   VARCHAR(40),
  to_status     VARCHAR(40),
  role_name     VARCHAR(40) REFERENCES roles(role_name),
  is_active     BOOLEAN DEFAULT TRUE
);

4. حشو صلاحيات مثال
sqlDownloadCopy code WrapINSERT INTO wf.permissions(from_status, to_status, role_name) VALUES
('DRAFT','PENDING','restaurant'),
('PENDING','APPROVED','bank'),
('PENDING','REJECTED','bank'),
('APPROVED','IN_PROGRESS','system'),
('IN_PROGRESS','COMPLETED','system'),
('COMPLETED','CLOSED','system');

5. دالة PostgreSQL – تنفيذ الانتقال مع التحقق
sqlDownloadCopy code WrapCREATE OR REPLACE FUNCTION wf.execute_transition(
  p_entity_type VARCHAR, p_entity_pk UUID,
  p_to_status   VARCHAR, p_user_id UUID,
  p_note TEXT DEFAULT NULL, p_old JSONB DEFAULT NULL, p_new JSONB DEFAULT NULL
)
RETURNS VOID AS $$
DECLARE
  v_opn   wf.operations%ROWTYPE;
  v_perm  BOOLEAN;
BEGIN
  -- جلب العملية
  SELECT * INTO v_opn
    FROM wf.operations
   WHERE entity_type=p_entity_type AND entity_pk=p_entity_pk;

  IF NOT FOUND THEN
     RAISE EXCEPTION 'Operation not found';
  END IF;

  -- هل مسموح لهذا الدور؟
  SELECT TRUE INTO v_perm
    FROM wf.permissions
   WHERE from_status=v_opn.current_status
     AND to_status=p_to_status
     AND role_name=(SELECT role_name FROM users WHERE user_id=p_user_id)
     AND is_active;

  IF NOT v_perm THEN
     RAISE EXCEPTION 'Transition not allowed';
  END IF;

  -- إدراج الانتقال
  INSERT INTO wf.transitions(operation_id, from_status, to_status,
                           transitioned_by, note, old_data, new_data)
  VALUES (v_opn.operation_id, v_opn.current_status, p_to_status,
          p_user_id, p_note, p_old, p_new);

  -- تحديث الحالة الحالية
  UPDATE wf.operations
     SET current_status=p_to_status
   WHERE operation_id=v_opn.operation_id;

END;
$$ LANGUAGE plpgsql;

6. أمثلة استدعاءات API (Pseudo)
jsDownloadCopy code Wrap// Restaurant يوافق على التصميم
POST /api/design/{id}/approve
body: { userId: 'uuid', note: 'Looks good' }

Backend:
  SELECT execute_transition('Design', designId, 'APPROVED', userId, note, oldDesign, newDesign);

7. Scheduler – تحديث الحالات التلقائية
sqlDownloadCopy code Wrap-- installment → OVERDUE
CREATE OR REPLACE FUNCTION wf.set_overdue()
RETURNS VOID AS $$
UPDATE wf.operations
   SET current_status='OVERDUE'
 WHERE op_type='INSTALLMENT_DUE'
   AND current_status='UPCOMING'
   AND requested_at < CURRENT_DATE - INTERVAL '1 day';
$$ LANGUAGE sql;
تُنفذ كل ساعة عبر pgAgent أو cron:
bashDownloadCopy code Wrappsql -d landspace -c "SELECT wf.set_overdue();"

8. ERD للـWorkflow (Mermaid)
mermaidDownloadCopy code WraperDiagram
  USERS ||--o{ wf.operations : "requests"
  wf.operations ||--o{ wf.transitions : "changes"
  wf.transitions }o--|| USERS : "done by"
  wf.permissions }o--|| roles : "allows"

9. لوحة عرض (Dashboard) – React فكرة

* My Tasks: قائمة العمليات التي في حالتها الحالية + صلاحيتي أستطيع التحويل.
* Timeline: خط زمني لكل transition مع الأيقونات (Color = الحالة).
* Filters: حسب النوع, التاريخ, requested_by.


10. Deliverables جاهزة للتصدير

*  SQL ملف (DDL للجداول الجديدة)
*  دالة execute_transition SQL
*  Swagger endpoint /api/{entity}/{id}/transition
*  React Component <WorkflowTimeline />
*  pgAgent script (cron) للحالات التلقائية


هل تود أن أرسل لك الآن:

1. ملف SQL جاهز للتنفيذ؟
2. Swagger YAML للـTransition API؟
3. كود React لمكون الـTimeline؟
===============================================================
أريد أن ترسم لي مخطط Workflow بصيغة BPMN/Swimlane رسومي يوضح:
(المطعم ← البنك ← لاند سبايس ← المورد) والخطوات المتسلسلة مع الحالات؟ بحيث يكون سهل فهمه للإدارة والمطورين معًا
لكل شي في التطبيق
============================================================
فيما يلي مخطط سير BPMN 2.0 رسوميّ (Swim-lane) مكتوب بلغة Mermaid يشرح التدفق الكامل بين أطراف الأربعة:

* المطعم (Restaurant)
* البنك (Bank)
* لاند سبايس (LandSpace)
* المورد (Supplier)

مع كل الحالات والتحويلات من التسجيل وحتى انتهاء العقد ودفع آخر قسط.
انسخ الكود إلى Mermaid Live Editor لترى الرسم التفاعلي.

mermaidDownloadCopy code Wrap%% ----- LandSpace – BPMN Swim-lane (Full Workflow) -----
flowchart TD
    %% ========= Swim-lane dividers (for clarity only) =========
    subgraph RESTAURANT_LANE [👤 Restaurant]
        direction TB
        R1((Start)) --> R2[Register Account]
        R2 --> R3[Submit Guarantee Request]
        R3 --> R4{Guarantee<br>Approved?}
        R4 -->|No| R4X[Rejected / Exit]
        R4 -->|Yes| R5[Request Design]
        R5 --> R6{Design<br>Approved?}
        R6 -->|No| R5
        R6 -->|Yes| R7[Approve Design]
        R7 --> R8[Request Printing]
        R8 --> R9{Prints<br>Received?}
        R9 -->|Yes| R10[Receive Products]
        R9 -->|No| R9
        R10 --> R11[Pay Invoice]
        R11 --> R12[Pay Installment]
    end

    subgraph BANK_LANE [🏦 Bank]
        direction TB
        B1(( )) --> B2[Review Guarantee]
        B2 --> B3{Approve?}
        B3 -->|Yes| B4[Issue Guarantee]
        B3 -->|No| B4X[Reject & Notify]
        B4 --> B5[Collect Installments Pool]
        B5 --> B6[Approve PO to Supplier]
        B6 --> B7[Pay Supplier]
        B7 --> B8{Installment<br>Overdue?}
        B8 -->|Yes| B9[Collect Late Payment]
        B8 -->|No| B10[Receive Payment]
    end

    subgraph LANDSPACE_LANE [🏭 LandSpace]
        direction TB
        L1(( )) --> L2[Review Restaurant Data]
        L2 --> L3{Activate?}
        L3 -->|Yes| L4[Notify Bank]
        L3 -->|No| L3X[Hold]
        L4 --> L5[Assign Designer]
        L5 --> L6{Design<br>Approved?}
        L6 -->|Yes| L7[Create Batch PO]
        L6 -->|No| L5
        L7 --> L8[Send PO to Bank]
        L8 --> L9{Prints<br>Received?}
        L9 -->|Yes| L10[Fill & Pack]
        L9 -->|No| L9
        L10 --> L11[Issue Invoice]
        L11 --> L12[Schedule Delivery]
        L12 --> L13[Deliver Products]
        L13 --> L14{Contract<br>End?}
        L14 -->|Yes| L15[Close Contract]
        L14 -->|No| L7
    end

    subgraph SUPPLIER_LANE [🧺 Supplier]
        direction TB
        S1(( )) --> S2[Receive PO from Bank]
        S2 --> S3{Accept?}
        S3 -->|Yes| S4[Print Labels]
        S3 -->|No| S4X[Reject PO]
        S4 --> S5[Update Progress]
        S5 --> S6{Progress = 100%?}
        S6 -->|Yes| S7[Ship to LandSpace]
        S6 -->|No| S5
        S7 --> S8[Notify Bank & LandSpace]
    end

    %% ========= Cross-lane Messages =========
    R3 -.-> B2
    B4 -.-> R4
    R5 -.-> L5
    L7 -.-> B6
    B6 -.-> S2
    S7 -.-> L9
    L10 -.-> R11
    R11 -.-> B10
    B9 -.-> R12
    R12 -.-> B10
    B10 -.-> L14

شرح سريع للرموز المستخدمة
رمزمعناه(())بداية/نهاية (Start/End Event)[]مهمة (Task){}بوابة قرار (Gateway)-->تدفق عادي-.->رسالة (Message Flow) بين LanesLane مظللمجموعة مهام داخل طرف واحد

مميزات هذا المخطط

1. واضح لغير التقني: كل lane يمثل جهة فعلية.
2. معروفة الحالات: كل بوابة {condition?} تُظهر نقطة القرار.
3. قابل للتعديل: بإضافة خطوة أو حذفها من الكود بسهولة.
4. يعمل مباشرة: انسخ الكود إلى Mermaid Live أو أي أداة تدعم Mermaid (GitBook، Notion، VSCode).


هل ترغب أن أصدر لك نفس المخطط بصيغة:

* رسومي PNG عالي الدقة (عبر تحويل Mermaid إلى SVG/PNG)؟
* أو XML صالح لأدوات BPMN مثل Camunda؟

==============================================


التقنيات المقترحة:

NodeJS: ^22
NextJS:^15.5.3
React: ^19.1.1
Prisma: ^6.16.1
NextAuth: ^5
zod:^4.1.8
zustand: ^5.0.8
Tailwindcss: ^4.1.13
Typescript: ^5.9.2
bcryptjs: ^3.0.2
PostgreSQL: ^v17